#!/bin/bash

# Fail on error
set -e

# Paths
AICCU_ROOT=/var/run/aiccu

# Arguments
function usage() {
	echo "$0 disable | { enable <iface> <server> <tls> <user> <pw> <tunnel> }" >&2
	exit 1
}

cfg_action=$1; shift || usage

case "$cfg_action" in
	enable)
		# Arguments
		cfg_iface=$1; shift || usage
		cfg_server=$1; shift || usage
		cfg_tls=$1; shift || usage
		cfg_username=$1; shift || usage
		cfg_password=$1; shift || usage
		cfg_tunnelid=$1; shift || usage

		# Generate config & enable
		echo 'Enabling AICCU and re-generating config file'
		mkdir -p $AICCU_ROOT
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'protocol tic'
		 echo "server $cfg_server"
		 echo "requiretls $cfg_tls"
		 echo "username $cfg_username"
		 echo "password $cfg_password"
		 echo "tunnel_id $cfg_tunnelid"
		 echo "ipv6_interface $cfg_iface"
		 echo 'automatic true'
		 echo 'defaultroute false'
		 echo 'makebeats true'
		 echo 'daemonize true'
		 echo "pidfile $AICCU_ROOT/$cfg_iface.pid"
		) > $AICCU_ROOT/$cfg_iface.conf
		
		# (Re)start
		aiccu stop $AICCU_ROOT/$cfg_iface.conf
		aiccu start $AICCU_ROOT/$cfg_iface.conf || exit 1
		;;
	disable)
		echo 'Disabling AICCU'

		# Disable & stop
		aiccu stop $AICCU_ROOT/$cfg_iface.conf
		rm $AICCU/$cfg_iface.conf
		;;
	*)
		usage
		;;
esac

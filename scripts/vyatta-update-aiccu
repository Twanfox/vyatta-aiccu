#!/bin/bash

# Fail on error
set -e

# Paths
AICCU_VAR=/var/run/aiccu
AICCU_BIN=/usr/sbin/aiccu

# Arguments
function usage() {
	echo "$0" >&2
	echo "  create <iface> <alias> |" >&2
	echo "  start <iface> <server> <requiretls> <user> <pw> <tunnel> |" >&2
	echo "  stop <iface> |" >&2
	echo "  remove <iface>" >&2
	exit 1
}

function die() {
	echo "interfaces aiccu $cfg_iface: $1" >&2
	exit 1
}

function report() {
	echo "interfaces aiccu $cfg_iface: $1"
}

function iface_stop() {
	# Disable & stop
	if [ -f $AICCU_VAR/$cfg_iface.conf ]; then
		if $AICCU_BIN stop $AICCU_VAR/$cfg_iface.conf; then
			report "stopped interface"
		else
			report "unable to stop interface, continuing..."
		fi
	fi
}

function iface_remove() {
	# Stop first
	iface_stop

	# Remove tunnel interface
	if [ x$(ip tuntap | grep -c "^$cfg_iface:") != x0 ]; then
		if ip tuntap del mode tun pi $cfg_iface; then
			report "removed interface"
		else
			report "unable to remove interface, continuing..."
		fi
	fi
}

function iface_create() {
	if [ x$(ip tuntap | grep -c "^$cfg_iface:") == x0 ]; then
		if ip tuntap add mode tun pi $cfg_iface; then
			report "created interface"
		else
			die "failed to create tunnel interface"
		fi
	else
		report "interface already exists, continuing..."
	fi
}

function iface_start() {
	# (Re)start
	#$AICCU_BIN stop $AICCU_VAR/$cfg_iface.conf >/dev/null 2>&1 || true
	if $AICCU_BIN start $AICCU_VAR/$cfg_iface.conf; then
		report "started interface"
	else
		die "failed to start interface"
	fi
}

cfg_action=$1; shift || usage

case "$cfg_action" in
	create)
		# Arguments
		cfg_iface=$1; shift || usage
		cfg_alias=$1; shift || usage
		
		# Create tunnel interface
		iface_create
		echo "$cfg_alias" > /sys/class/net/$cfg_iface/ifalias || \
			die "failed to set interface description"
		
		# If we've got a config file already, try to start
		if [ -f $AICCU_VAR/$cfg_iface.conf ]; then
			iface_start
		else
			report "no configuration file yet, deferred start"
		fi
		;;
	start)
		# Arguments
		cfg_iface=$1; shift || usage
		cfg_server=$1; shift || usage
		cfg_requiretls=$1; shift || usage
		cfg_username=$1; shift || usage
		cfg_password=$1; shift || usage
		cfg_tunnelid=$1; shift || usage
		
		# Generate config & enable
		mkdir -p $AICCU_VAR
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'protocol tic'
		 if [ "$cfg_server" != "" ]; then
		 	echo "server $cfg_server"
		 else
		 	echo "server tic.sixxs.net"
		 fi
		 if [ "$cfg_requiretls" != "" ]; then
			echo "requiretls $cfg_requiretls"
		 else
		 	echo "requiretls true"
		 fi
		 echo "username $cfg_username"
		 echo "password $cfg_password"
		 echo "tunnel_id $cfg_tunnelid"
		 echo "ipv6_interface $cfg_iface"
		 echo 'automatic true'
		 echo 'defaultroute false'
		 echo 'makebeats true'
		 echo 'daemonize true'
		 echo 'verbose true'
		 echo "pidfile $AICCU_VAR/$cfg_iface.pid"
		) > $AICCU_VAR/$cfg_iface.conf || \
			die "failed to create config file"
		
		# (Re)Start interface
		iface_start
		;;
	stop)
		# Arguments
		cfg_iface=$1; shift || usage

		# Stop interface
		iface_stop
		;;
	remove)
		# Arguments
		cfg_iface=$1; shift || usage
		
		# Remove interface
		iface_stop
		iface_remove
		rm $AICCU_VAR/$cfg_iface.conf >/dev/null 2>&1 || true
		;;
	*)
		usage
		;;
esac

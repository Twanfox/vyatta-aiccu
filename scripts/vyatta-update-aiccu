#!/bin/bash

# Fail on error
set -e

# Paths
AICCU_VAR=/var/run/aiccu
AICCU_BIN=/usr/sbin/aiccu

# Arguments
function usage() {
	echo "$0" >&2
	echo "  create <iface> |" >&2
	echo "  start <iface> <server> <requiretls> <user> <pw> <tunnel> |" >&2
	echo "  stop <iface> |" >&2
	echo "  remove <iface>" >&2
	exit 1
}

function die() {
	echo "interfaces aiccu $cfg_iface: $1" >&2
	exit 1
}

cfg_action=$1; shift || usage

case "$cfg_action" in
	create)
		# Arguments
		cfg_iface=$1; shift || usage
		
		# Create tunnel interface
		ip tuntap add mode tun pi $cfg_iface || \
			die "failed to create tunnel interface"
		;;
	start)
		# Arguments
		cfg_iface=$1; shift || usage
		cfg_server=$1; shift || usage
		cfg_requiretls=$1; shift || usage
		cfg_username=$1; shift || usage
		cfg_password=$1; shift || usage
		cfg_tunnelid=$1; shift || usage

		# Generate config & enable
		mkdir -p $AICCU_VAR
		(echo '#Generated by Vyatta, do not edit!'
		 echo 'protocol tic'
		 if [ "$cfg_server" != "" ]; then
		 	echo "server $cfg_server"
		 else
		 	echo "server tic.sixxs.net"
		 fi
		 if [ "$cfg_requiretls" != "" ]; then
			echo "requiretls $cfg_requiretls"
		 else
		 	echo "requiretls true"
		 fi
		 echo "username $cfg_username"
		 echo "password $cfg_password"
		 echo "tunnel_id $cfg_tunnelid"
		 echo "ipv6_interface $cfg_iface"
		 echo 'automatic true'
		 echo 'defaultroute false'
		 echo 'makebeats true'
		 echo 'daemonize true'
		 echo 'verbose true'
		 echo "pidfile $AICCU_VAR/$cfg_iface.pid"
		) > $AICCU_VAR/$cfg_iface.conf || \
			die "failed to create config file"
		
		# (Re)start
		$AICCU_BIN stop $AICCU_VAR/$cfg_iface.conf >/dev/null 2>&1 || true
		$AICCU_BIN start $AICCU_VAR/$cfg_iface.conf || \
			die "failed to establish tunnel"
		echo "interfaces aiccu $cfg_iface: started"
		;;
	stop)
		# Arguments
		cfg_iface=$1; shift || usage

		# Disable & stop
		if [ -f $AICCU_VAR/$cfg_iface.conf ]; then
			$AICCU_BIN stop $AICCU_VAR/$cfg_iface.conf || true
			rm $AICCU_VAR/$cfg_iface.conf >/dev/null 2>&1
		fi
		;;
	remove)
		# Arguments
		cfg_iface=$1; shift || usage
		
		# Disable & stop
		if [ -f $AICCU_VAR/$cfg_iface.conf ]; then
			$AICCU_BIN stop $AICCU_VAR/$cfg_iface.conf || true
			rm $AICCU_VAR/$cfg_iface.conf >/dev/null 2>&1
		fi
		
		# Remove tunnel interface
		ip tuntap del mode tun pi $cfg_iface ||
			die "failed to remove tunnel interface"
		;;
	*)
		usage
		;;
esac
